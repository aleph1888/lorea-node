#
# -*- mode: shell-script -*-
#

lorea_setup_config() {
    local var="$1"
    local val="$2"

    $LOREA["$var"]="$val"
}

lorea_setup_dirs() {
    test -d $(_TMP) || mkdir -m 0710 -p $(_TMP)/{cache,pids,sockets}
}

lorea_setup_status() {
    echo -e "\n  .:| Lorea Setup For $LOREA_USER |:.\n"
    echo "  Local repository:   $LOREA_DIR"
    if [ ! -d "$LOREA_DIR/.git" ]; then
        echo "  - The lorea-node repository is missing."
    fi
    if [ -x $(which lorea) ]; then
        echo "  + The lorea command is in PATH."
    else
        echo "  - The lorea command is not in PATH."
    fi
    if [ -d $(_ELGG) ]; then
        echo "  + Elgg 1.8 sources are present."
    else
        echo "  - Elgg 1.8 sources are missing."
    fi
    if [ -d $(_ELGG)/mod/lorea_framework ]; then
        echo "  + Lorea Framework is present"
    else
        echo "  - Lorea Framework is not installed."
    fi
    if [ -d $(_HUB) ]; then
        echo "  + $(lorea_status node_count)"
    else
        echo "  - To create your first node, type lorea node new"
    fi
}

lorea_setup_tools() {
    # Setup Miyamoto
    say " + Setting up Miyamoto (noop)"
    # Setup Cryptobot
    say " + Setting up Cryptobot (noop)"
    if [ "127.0.0.1" = "$LOREA_IP" -o "$LOREA_USER.lorea.local" = "$LOREA_HOST" ]; then
        # Local node: setup Desktop tools
        say " + Setting up Desktop tools (noop)"
    fi
}

lorea_setup_user() { _installer_run_user_setup; }

_installer_init_elgg_git() {
    test -d "$(_ELGG)" && return 0

    _lorea_env

    cd $LOREA_DIR

    local gsa="git submodule add"
    local repo="https://github.com/lorea/Elgg.git"
    local branch="master"
    test "development" = "$LOREA_ENV" && branch="development" && gsa="$gsa -b $branch"
    $gsa $repo elgg && git submodule init elgg && git submodule update elgg
}

_installer_run_user_setup() {
    mkdir -m 0700 "$HOME/.config/lorea" || true
    local extra_config=""
    local o=
    for var in ${!LOREA_@}; do
        o=$(eval echo \$$var)
        test -z "$var" && echo "  $var is not set" || echo "  $var=\"$o\""
        echo " *  Change $var or press Enter to continue"
        read -e -i "$o" -p '    => ' val
        if [ -n "$val" -a "x$val" != "x$o" ]; then
            eval "$var=\"$val\""
            extra_config=$(echo -e "$var=\"$val\"\n$extra_config")
            echo "  $var set to $val"
        else
            echo "  $var unchanged ($o)"
        fi
    done
    mkdir -p "$HOME/.config/lorea/" || true
    chmod 0700 "$HOME/.config/lorea/"
    cat > "$HOME/.config/lorea/rc" <<EOF
# -*- Mode: shell-script -*-
#
## User Configuration for lorea-node
#
# This is a shell fragment sourced by the lorea command.
# DO NOT EDIT THIS FILE: use the 'lorea setup' command instead.
#
## LOREA_DIR
#
# Path to your local copy of the lorea-node Git repository.
#
# You can override the default ~/lorea-node to point to your own repo.
# For a shared installation, you might use /usr/share/lorea/.
# 
LOREA_DIR="$LOREA_DIR"
#
# You can override any default configuration by setting a different
# value in this file.  All values are defined in etc/lorearc.
#
$extra_config
#
# File generated at $(date +%F_%T) by $0
#
EOF
    mkdir -m 0755 "$HOME/.local/share/lorea" || true
}

#lorea_installer_install_framework() {
#    # Fetch all modules according to LOREA_ENV 
#    # Link them into the elgg/mod dir.
#    if [ -x git ]; then
#        for module in `/bin/ls plugins`; do
#            local d=$(basename $module)
#            test -x elgg/mod/$d || ln -s $(absolute_path $module) $(absolute_path elgg/mod/)
#        done
#    else
#        say "xxx Oops...  Not implemented: you need git."
#    fi
#    echo 0
#}

